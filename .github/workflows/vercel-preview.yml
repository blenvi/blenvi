# Vercel Preview Deployment
# This workflow provides status checks for Vercel deployments
# Actual deployment is handled by Vercel's Git integration

name: Vercel Preview Deployment

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  # Check if builds are needed based on changed files
  check-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web }}
      docs: ${{ steps.filter.outputs.docs }}

    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'apps/web/**'
              - 'packages/ui/**'
              - 'packages/typescript-config/**'
              - 'packages/eslint-config/**'
              - 'package.json'
              - 'turbo.json'
            docs:
              - 'apps/docs/**'
              - 'packages/typescript-config/**'
              - 'packages/eslint-config/**'
              - 'package.json'
              - 'turbo.json'

  # Validate builds before Vercel deploys
  validate-builds:
    name: Validate Builds
    runs-on: ubuntu-latest
    needs: check-changes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint all packages
        run: npm run lint
        continue-on-error: true

      - name: Type check
        run: npm run type-check
        continue-on-error: true

      - name: Build Web App
        if: needs.check-changes.outputs.web == 'true'
        run: npm run build --filter=web
        env:
          SKIP_ENV_VALIDATION: true

      - name: Build Docs
        if: needs.check-changes.outputs.docs == 'true'
        run: npm run build --filter=docs
        env:
          SKIP_ENV_VALIDATION: true

  # Report which apps will be deployed
  report:
    name: Deployment Report
    runs-on: ubuntu-latest
    needs: check-changes

    steps:
      - name: Generate Job Summary
        run: |
          echo "## ðŸš€ Vercel Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| App | Will Deploy | Changed Files |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Web App | ${{ needs.check-changes.outputs.web == 'true' && 'âœ… Yes' || 'â­ï¸ Skip' }} | ${{ needs.check-changes.outputs.web == 'true' && 'Detected' || 'None' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ needs.check-changes.outputs.docs == 'true' && 'âœ… Yes' || 'â­ï¸ Skip' }} | ${{ needs.check-changes.outputs.docs == 'true' && 'Detected' || 'None' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> Vercel will automatically deploy preview URLs for apps with changes." >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const web = '${{ needs.check-changes.outputs.web }}' === 'true';
            const docs = '${{ needs.check-changes.outputs.docs }}' === 'true';

            let comment = '## ðŸš€ Vercel Deployment Status\n\n';
            comment += '| App | Will Deploy | Changed Files |\n';
            comment += '|-----|-------------|---------------|\n';
            comment += `| Web App | ${web ? 'âœ… Yes' : 'â­ï¸ Skip'} | ${web ? 'Detected' : 'None'} |\n`;
            comment += `| Docs | ${docs ? 'âœ… Yes' : 'â­ï¸ Skip'} | ${docs ? 'Detected' : 'None'} |\n`;
            comment += '\n';
            comment += '> Vercel will automatically deploy preview URLs for apps with changes.\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
